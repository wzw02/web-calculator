name: CD Pipeline - Blue-Green Deploy

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to VM
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
          cd ~/web-calculator
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git pull origin main
          
          # æ‰§è¡ŒBlue-Greenéƒ¨ç½²è„šæœ¬
          chmod +x deploy/blue-green-switch.sh
          IMAGE_TAG=${{ github.sha }} ./deploy/blue-green-switch.sh
          
    - name: Verify deployment
      run: |
        # æ£€æŸ¥éƒ¨ç½²æ˜¯å¦æˆåŠŸ
        sleep 30
        curl -f http://${{ secrets.VM_HOST }}/health || exit 1
        
    - name: Send notification
      if: success()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_MESSAGE: "âœ… éƒ¨ç½²æˆåŠŸï¼Webè®¡ç®—å™¨å·²æ›´æ–°åˆ°ç‰ˆæœ¬: ${{ github.sha }}"
        
  rollback:
    needs: deploy
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          cd ~/web-calculator
          # åˆ‡æ¢åˆ°ä¹‹å‰çš„ç‰ˆæœ¬
          CURRENT_COLOR=$(cat .current_color)
          if [ "$CURRENT_COLOR" = "blue" ]; then
            NEW_COLOR="green"
          else
            NEW_COLOR="blue"
          fi
          
          echo "ðŸ”„ å›žæ»šåˆ° $NEW_COLOR çŽ¯å¢ƒ"
          docker-compose up -d app_$NEW_COLOR
          sleep 10
          
          # æ›´æ–°nginxé…ç½®
          cp nginx/upstream-$NEW_COLOR.conf nginx/upstream.conf
          docker-compose exec -T proxy nginx -s reload
          echo $NEW_COLOR > .current_color
