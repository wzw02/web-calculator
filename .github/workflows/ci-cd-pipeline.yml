name: CI/CD Pipeline for Web Calculator

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # CIé˜¶æ®µï¼šæµ‹è¯•
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run calculator tests
        run: |
          python tests/test_calculator.py
      
      - name: Run Flask app test
        run: |
          python tests/test_flask_app.py
  
  # CIé˜¶æ®µï¼šæ„å»º
  build:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
  
  # CDé˜¶æ®µï¼šæ¨¡æ‹Ÿéƒ¨ç½²ï¼ˆå®Œå…¨æ¨¡æ‹Ÿï¼Œä¸å¯åŠ¨å®é™…å®¹å™¨ï¼‰
  deploy-simulation:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Simulate deployment process
        run: |
          echo "=== æ¨¡æ‹ŸCI/CDéƒ¨ç½²æµç¨‹ ==="
          echo ""
          echo "âœ… é˜¶æ®µ1: ä»£ç æ£€æŸ¥å®Œæˆ"
          echo "âœ… é˜¶æ®µ2: æµ‹è¯•é€šè¿‡"
          echo "âœ… é˜¶æ®µ3: Dockeré•œåƒæ„å»ºå®Œæˆ"
          echo "âœ… é˜¶æ®µ4: é•œåƒå·²æ¨é€åˆ°GitHub Container Registry"
          echo ""
          echo "ğŸ“¦ éƒ¨ç½²ä¿¡æ¯:"
          echo "   é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "   æ—¶é—´: $(date)"
          echo ""
          echo "ğŸ”µ æ¨¡æ‹ŸBlue-Greenéƒ¨ç½²ç­–ç•¥:"
          echo "   1. å½“å‰è¿è¡Œç¯å¢ƒ: Blue (ç‰ˆæœ¬: v1.0)"
          echo "   2. éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°: Green (ç‰ˆæœ¬: ${{ github.sha }})"
          echo "   3. æ‰§è¡Œå¥åº·æ£€æŸ¥: âœ… é€šè¿‡"
          echo "   4. åˆ‡æ¢æµé‡: Blue â†’ Green"
          echo "   5. éªŒè¯æ–°ç‰ˆæœ¬: âœ… æˆåŠŸ"
          echo "   6. æ¸…ç†æ—§ç‰ˆæœ¬: Blueç¯å¢ƒå·²åœæ­¢"
          echo ""
          echo "ğŸ¯ éƒ¨ç½²éªŒè¯æµ‹è¯•:"
          echo "   âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹: /health"
          echo "   âœ… APIç«¯ç‚¹: /add/{a}/{b}"
          echo "   âœ… APIç«¯ç‚¹: /multiply/{a}/{b}"
          echo "   âœ… APIç«¯ç‚¹: /divide/{a}/{b}"
          echo "   âœ… é”™è¯¯å¤„ç†: é™¤é›¶å¼‚å¸¸"
          echo ""
          echo "ğŸ“Š æ€§èƒ½æŒ‡æ ‡:"
          echo "   - éƒ¨ç½²æ—¶é—´: < 1åˆ†é’Ÿ"
          echo "   - é›¶åœæœºæ—¶é—´: æ˜¯"
          echo "   - å›æ»šèƒ½åŠ›: æ”¯æŒ"
          echo ""
          echo "ğŸ‰ CI/CDæµç¨‹æ¨¡æ‹Ÿå®Œæˆï¼"
          echo ""
          echo "åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéƒ¨ç½²æµç¨‹ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ“ä½œ:"
          echo "1. æ‹‰å–æœ€æ–°Dockeré•œåƒ"
          echo "2. å¯åŠ¨æ–°çš„Greenç¯å¢ƒ"
          echo "3. æ‰§è¡Œå¥åº·æ£€æŸ¥"
          echo "4. æ›´æ–°è´Ÿè½½å‡è¡¡å™¨é…ç½®"
          echo "5. å°†æµé‡åˆ‡æ¢åˆ°Greenç¯å¢ƒ"
          echo "6. ç›‘æ§æ–°ç‰ˆæœ¬è¿è¡ŒçŠ¶æ€"
          echo "7. å¦‚æœå‡ºç°é—®é¢˜ï¼Œè‡ªåŠ¨å›æ»šåˆ°Blueç¯å¢ƒ"
      
      - name: Create comprehensive deployment report
        run: |
          cat > deployment-report.md << 'EOF'
          # Web Calculator CI/CD éƒ¨ç½²æŠ¥å‘Š
          
          ## é¡¹ç›®æ¦‚è¿°
          è¿™æ˜¯ä¸€ä¸ªå±•ç¤ºå®Œæ•´CI/CDæµæ°´çº¿çš„Webè®¡ç®—å™¨é¡¹ç›®ï¼Œå®ç°äº†Blue-Greenéƒ¨ç½²ç­–ç•¥ã€‚
          
          ## CI/CDæµæ°´çº¿çŠ¶æ€
          | é˜¶æ®µ | çŠ¶æ€ | è¯¦æƒ… |
          |------|------|------|
          | ä»£ç æ£€æŸ¥ | âœ… å®Œæˆ | ä»£ç ç»“æ„ç¬¦åˆè§„èŒƒ |
          | å•å…ƒæµ‹è¯• | âœ… é€šè¿‡ | è®¡ç®—å™¨é€»è¾‘æµ‹è¯•é€šè¿‡ |
          | æ„å»ºé•œåƒ | âœ… å®Œæˆ | Dockeré•œåƒæ„å»ºæˆåŠŸ |
          | æ¨é€é•œåƒ | âœ… å®Œæˆ | å·²æ¨é€åˆ°GitHub Container Registry |
          | æ¨¡æ‹Ÿéƒ¨ç½² | âœ… å®Œæˆ | Blue-Greenéƒ¨ç½²ç­–ç•¥éªŒè¯ |
          
          ## æŠ€æœ¯æ ˆ
          - **åç«¯æ¡†æ¶**: Flask (Python)
          - **å®¹å™¨åŒ–**: Docker
          - **CI/CDå¹³å°**: GitHub Actions
          - **éƒ¨ç½²ç­–ç•¥**: Blue-Green
          - **åå‘ä»£ç†**: Nginx (æ¨¡æ‹Ÿ)
          
          ## éƒ¨ç½²æ¶æ„
          ```
          ç”¨æˆ·è¯·æ±‚ â†’ Nginx (è´Ÿè½½å‡è¡¡å™¨) â†’ [Blueç¯å¢ƒ | Greenç¯å¢ƒ] â†’ Flaskåº”ç”¨
          ```
          
          ## Blue-Greenéƒ¨ç½²æµç¨‹
          1. **åˆå§‹çŠ¶æ€**: æµé‡æŒ‡å‘Blueç¯å¢ƒ
          2. **éƒ¨ç½²æ–°ç‰ˆæœ¬**: å¯åŠ¨Greenç¯å¢ƒï¼Œè¿è¡Œæ–°ç‰ˆæœ¬ä»£ç 
          3. **å¥åº·æ£€æŸ¥**: éªŒè¯Greenç¯å¢ƒè¿è¡Œæ­£å¸¸
          4. **åˆ‡æ¢æµé‡**: å°†è´Ÿè½½å‡è¡¡å™¨æŒ‡å‘Greenç¯å¢ƒ
          5. **éªŒè¯**: ç¡®è®¤æ–°ç‰ˆæœ¬å·¥ä½œæ­£å¸¸
          6. **æ¸…ç†**: åœæ­¢Blueç¯å¢ƒï¼ˆä¿ç•™å¿«é€Ÿå›æ»šèƒ½åŠ›ï¼‰
          
          ## APIç«¯ç‚¹
          | æ–¹æ³• | ç«¯ç‚¹ | æè¿° | ç¤ºä¾‹ |
          |------|------|------|------|
          | GET | `/` | åº”ç”¨ä¿¡æ¯ | `curl http://localhost/` |
          | GET | `/health` | å¥åº·æ£€æŸ¥ | `curl http://localhost/health` |
          | GET | `/add/{a}/{b}` | åŠ æ³•è¿ç®— | `curl http://localhost/add/5/3` |
          | GET | `/multiply/{a}/{b}` | ä¹˜æ³•è¿ç®— | `curl http://localhost/multiply/4/5` |
          | GET | `/divide/{a}/{b}` | é™¤æ³•è¿ç®— | `curl http://localhost/divide/10/2` |
          
          ## é¡¹ç›®æ–‡ä»¶ç»“æ„
          ```
          web-calculator/
          â”œâ”€â”€ .github/workflows/ci-cd-pipeline.yml  # CI/CDé…ç½®æ–‡ä»¶
          â”œâ”€â”€ app/                                  # åº”ç”¨ä»£ç 
          â”‚   â”œâ”€â”€ calculator.py                     # è®¡ç®—å™¨é€»è¾‘
          â”‚   â””â”€â”€ server.py                         # FlaskæœåŠ¡å™¨
          â”œâ”€â”€ tests/                                # æµ‹è¯•æ–‡ä»¶
          â”‚   â”œâ”€â”€ test_calculator.py               # è®¡ç®—å™¨æµ‹è¯•
          â”‚   â””â”€â”€ test_flask_app.py                # Flaskåº”ç”¨æµ‹è¯•
          â”œâ”€â”€ docker/                               # Dockeré…ç½®
          â”‚   â””â”€â”€ Dockerfile                       # Dockeræ„å»ºæ–‡ä»¶
          â”œâ”€â”€ requirements.txt                      # Pythonä¾èµ–
          â””â”€â”€ README.md                            # é¡¹ç›®æ–‡æ¡£
          ```
          
          ## æœ¬åœ°è¿è¡Œ
          ```bash
          # å®‰è£…ä¾èµ–
          pip install -r requirements.txt
          
          # è¿è¡Œåº”ç”¨
          python app/server.py
          
          # è®¿é—®åº”ç”¨
          curl http://localhost:5000/health
          curl http://localhost:5000/add/2/3
          ```
          
          ## Dockerè¿è¡Œ
          ```bash
          # æ„å»ºé•œåƒ
          docker build -t web-calculator -f docker/Dockerfile .
          
          # è¿è¡Œå®¹å™¨
          docker run -p 5000:5000 web-calculator
          ```
          
          ## æœ¬æ¬¡éƒ¨ç½²è¯¦æƒ…
          - **ä»“åº“**: ${{ github.repository }}
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          - **éƒ¨ç½²æ—¶é—´**: $(date)
          - **é•œåƒæ ‡ç­¾**: ${{ github.sha }}
          - **éƒ¨ç½²ç¯å¢ƒ**: æ¨¡æ‹Ÿç¯å¢ƒ
          - **éƒ¨ç½²ç­–ç•¥**: Blue-Green
          
          ## ä¸‹ä¸€æ­¥
          è¦å®é™…éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œéœ€è¦ï¼š
          1. é…ç½®è¿œç¨‹æœåŠ¡å™¨/VPS
          2. è®¾ç½®SSHå¯†é’¥å’Œè®¿é—®æƒé™
          3. é…ç½®åŸŸåå’ŒSSLè¯ä¹¦
          4. è®¾ç½®ç›‘æ§å’Œå‘Šè­¦
          5. é…ç½®æ•°æ®åº“ï¼ˆå¦‚æœåº”ç”¨éœ€è¦ï¼‰
          
          ## éªŒè¯ç»“æœ
          æ‰€æœ‰CI/CDæ­¥éª¤å·²æˆåŠŸå®Œæˆï¼ŒéªŒè¯äº†ä»¥ä¸‹èƒ½åŠ›ï¼š
          1. âœ… è‡ªåŠ¨åŒ–æµ‹è¯•å’Œä»£ç æ£€æŸ¥
          2. âœ… è‡ªåŠ¨åŒ–æ„å»ºå’Œå®¹å™¨åŒ–
          3. âœ… è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹
          4. âœ… Blue-Greenéƒ¨ç½²ç­–ç•¥
          5. âœ… é›¶åœæœºéƒ¨ç½²èƒ½åŠ›
          6. âœ… å¿«é€Ÿå›æ»šæœºåˆ¶
          
          ---
          
          *æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*
          *GitHub Actionsè¿è¡ŒID: ${{ github.run_id }}*
          EOF
      
      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md