name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/web-calculator

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r src/requirements.txt
        pip install pytest pytest-cov flake8 black 
        pip install bandit pbr
    
    - name: Lint code
      run: |
        flake8 src/
        black --check src/
        bandit -r src/ --format json
    
    - name: Run unit tests
      run: |
        cd src
        pytest tests/unit_tests.py -v --cov=. --cov-report=xml --cov-report=html
    
    - name: Start test container
      run: |
        docker build -t web-calculator-test -f docker/Dockerfile .
        docker run -d -p 5000:5000 \
          -e FLASK_ENV=development \
          -e PORT=5000 \
          --name webcalc-test \
          web-calculator-test
    
    - name: Wait for container to be ready
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:5000/health 2>/dev/null; then
            echo "Container is ready"
            break
          fi
          echo "Waiting for container... ($i/30)"
          sleep 2
        done
    
    - name: Run functional tests
      run: |
        chmod +x src/tests/functional_tests.sh
        ./src/tests/functional_tests.sh http://localhost:5000
    
    - name: Stop test container
      if: always()
      run: |
        docker stop webcalc-test || true
        docker rm webcalc-test || true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          src/coverage.xml
          src/htmlcov/
          src/test-results/
        retention-days: 7

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        labels: |
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    env:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Add server to known hosts
        ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
        
        # Test SSH connection
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "echo 'SSH connection successful'"
    
    - name: Copy deployment files
      run: |
        # Create remote directory
        ssh $SERVER_USER@$SERVER_HOST "mkdir -p /opt/web-calculator"
        
        # Copy Docker files
        scp -r docker/ $SERVER_USER@$SERVER_HOST:/opt/web-calculator/
        
        # Copy Docker Compose files
        scp docker-compose.yml docker-compose.prod.yml $SERVER_USER@$SERVER_HOST:/opt/web-calculator/
        
        # Copy environment example
        scp .env.example $SERVER_USER@$SERVER_HOST:/opt/web-calculator/.env.example
        
        # Make scripts executable
        ssh $SERVER_USER@$SERVER_HOST "chmod +x /opt/web-calculator/docker/scripts/*.sh"
    
    - name: Deploy application
      run: |
        # Execute deployment script
        ssh $SERVER_USER@$SERVER_HOST "cd /opt/web-calculator && ./docker/scripts/deploy.sh ${{ github.sha }}"
    
    - name: Verify deployment
      run: |
        # Wait for deployment to complete
        sleep 10
        
        # Verify application is running
        ssh $SERVER_USER@$SERVER_HOST "curl -f http://localhost/health || exit 1"
        
        echo "Deployment verification successful!"

  notify:
    needs: [test, build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Determine deployment status
      id: status
      run: |
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.build.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
          echo "DEPLOYMENT_STATUS= All stages passed" >> $GITHUB_OUTPUT
        else
          echo "DEPLOYMENT_STATUS= Some stages failed" >> $GITHUB_OUTPUT
        fi
    
    - name: Send status notification
      run: |
        echo "${{ steps.status.outputs.DEPLOYMENT_STATUS }}"
        echo "Test: ${{ needs.test.result }}"
        echo "Build: ${{ needs.build.result }}"
        echo "Deploy: ${{ needs.deploy.result }}"