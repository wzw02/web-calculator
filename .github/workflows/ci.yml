test:
  runs-on: ubuntu-latest
  services:
    docker:
      image: docker:24-dind
      options: --privileged
  
  steps:
  - uses: actions/checkout@v4
  
  - name: Set up Python
    uses: actions/setup-python@v4
    with:
      python-version: '3.12'
  
  - name: Install dependencies
    run: |
      pip install -r requirements.txt
      pip install pytest pytest-html
  
  - name: Build Docker image for tests
    run: |
      docker build -t web-calculator:${{ github.sha }} .
  
  - name: Run unit tests with report
    run: |
      # 生成XML和HTML两种报告格式
      python -m pytest tests/unit/ -v --junitxml=test-results.xml --html=test-report.html || true
  
  - name: Run functional tests
    run: |
      # 启动测试容器
      docker run -d -p 5000:5000 --name web-calc-test web-calculator:${{ github.sha }}
      
      # 等待应用启动（使用健康检查）
      echo "等待应用启动..."
      for i in {1..30}; do
        if curl -s -f http://localhost:5000/health > /dev/null; then
          echo "✓ 应用启动成功"
          break
        fi
        echo "等待应用启动... ($i/30)"
        sleep 2
      done
      
      # 检查应用是否真的启动了
      if ! docker ps | grep -q web-calc-test; then
        echo "容器未运行"
        docker logs web-calc-test
        exit 1
      fi
      
      # 创建测试报告目录
      mkdir -p tests/functional/reports
      
      # 运行功能测试并生成报告
      echo "开始功能测试..." > tests/functional/report.txt
      echo "=================" >> tests/functional/report.txt
      echo "测试时间: $(date)" >> tests/functional/report.txt
      echo "" >> tests/functional/report.txt
      
      # 测试健康端点
      echo "测试 /health 端点..." >> tests/functional/report.txt
      if curl -s -f http://localhost:5000/health; then
        echo "✓ /health 测试通过" >> tests/functional/report.txt
      else
        echo "✗ /health 测试失败" >> tests/functional/report.txt
        TEST_FAILED=true
      fi
      
      # 测试计算端点（根据实际应用调整）
      echo "" >> tests/functional/report.txt
      echo "测试计算端点..." >> tests/functional/report.txt
      
      # 示例：测试加法端点
      if curl -s "http://localhost:5000/add/2/3" | grep -q "5"; then
        echo "✓ 加法测试通过" >> tests/functional/report.txt
      else
        echo "✗ 加法测试失败" >> tests/functional/report.txt
        TEST_FAILED=true
      fi
      
      # 如果有测试失败，退出码为1
      if [ "$TEST_FAILED" = true ]; then
        echo " 功能测试失败" >> tests/functional/report.txt
        exit 1
      else
        echo "所有功能测试通过" >> tests/functional/report.txt
      fi
      
      # 复制报告到指定位置
      cp tests/functional/report.txt tests/functional/test-report.txt
  
  - name: Upload test reports
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: test-reports-${{ github.run_id }}
      path: |
        test-results.xml
        test-report.html
        tests/functional/test-report.txt
        tests/functional/report.txt